<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Bootstrap Home</title>
    <div th:include="bs-base :: bs-head"></div>

</head>
<body>
<div th:include="bs-base :: bs-nav"></div>
<div class="container">



    <div th:if="${groupid} == null">


        <div>

            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#unanno" aria-controls="unanno" role="tab" data-toggle="tab">Unannotated</a></li>
                <li role="presentation"><a href="#anno" aria-controls="anno" role="tab" data-toggle="tab">Annotated</a></li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
                <!-- This set of sentences is all unannotated -->
                <div role="tabpanel" class="tab-pane active" id="unanno">

                    <div class="spacer"></div>

                    <div class="row">
                        <div class="col-md-9">
                            <div class="list-group">
                                <div th:each="groupid : ${unannogroups.keySet()}" class="list-group-item">

                                    <a th:each="label : ${labels}" th:href="@{/bootstrap/addtextsave(text=${groupid},label=${label},groupid=${groupid})}" th:class="${label} + ' badge'" th:text="${label}"></a>

                                    <a th:href="'/bootstrap/sents?groupid=' + ${groupid}"><h4 th:text="'Group: ' + ${groupid} + ' (' + ${unannogroups.get(groupid).size()} + ' sentences)'" class="list-group-item-heading"></h4></a>
                                    <p th:text="'Num unlabeled:' + ${unlabeledamount.get(groupid)}"></p>
                                    <!--<p th:text="${unannogroups.get(groupid).get(0)}" class="list-group-item-text"></p>-->

                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="spacer"></div>
                            <p th:text="${labeledtokens} + '/' + ${totaltokens}"></p>
                            <p th:text="'Percentage: ' + 100*${labeledtokens}/${totaltokens}"></p>
                            <p th:text="'Num anno sents: ' + ${numannosents}"></p>
                            <p th:text="'Num sents in groups: ' + ${numsentsingroups}"></p>
                        </div>
                    </div>
                </div>

                <!-- This set of sentences is all annotated -->
                <div role="tabpanel" class="tab-pane" id="anno">

                    <div class="spacer"></div>

                    <div class="row">
                        <div class="col-md-9">
                            <div class="list-group">
                                <a th:each="groupid : ${annogroups.keySet()}" th:href="'/bootstrap/sents?groupid=' + ${groupid}" class="list-group-item">
                                    <h4 th:text="'Group: ' + ${groupid} + ' (' + ${annogroups.get(groupid).size()} + ' sentences)'" class="list-group-item-heading"></h4>
                                    <!--<p th:text="${annogroups.get(groupid).get(0)}" class="list-group-item-text"></p>-->

                                </a>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-default">Write out to file</button>
                            <div class="spacer"></div>
                            <p th:text="${labeledtokens} + '/' + ${totaltokens}"></p>
                            <p th:text="'Percentage: ' + 100*${labeledtokens}/${totaltokens}"></p>
                            <p th:text="'Num anno sents: ' + ${numannosents}"></p>


                        </div>

                    </div>

                </div>
            </div>

        </div>





    </div>

    <div th:unless="${groupid} == null">

        <h3 th:text="'Group: ' + ${groupid}"></h3>

        <div class="row">
            <div th:utext="${html}" id="htmlcontainer" class="col-md-8">
                <!--<div th:each="sentid : ${id2html.keySet()}" class="panel panel-default">-->
                    <!--<div  th:text="${sentid}" class="panel-heading"></div>-->
                    <!--<div class="panel-body text" th:id="${sentid}" th:utext="${id2html.get(sentid)}">-->
                    <!--</div>-->
                <!--</div>-->
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <a id="savebutton" class="btn btn-default" role="button"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span> Save</a>
                    <a id="dictbutton" class="btn btn-default" th:classappend="${session.dict.isEmpty()} ? disabled : mothing" role="button"><span class="glyphicon glyphicon-book" aria-hidden="true"></span> Toggle Dict.</a>

                    <div class="spacer"></div>
                    <button th:each="label : ${labels}" th:id="'addlabel-' + ${label}" th:class="${label} + ' btn'" th:text="${label}"></button>


                </div>

            </div>
        </div>



    </div>

</div>
</body>


<script th:inline="javascript">
    /*<![CDATA[*/

    $(document).ready(function() {

        function loadtok(){
            console.log("loadtok called...");


            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            })


            // just clean everything out first...
            //$("[id^=tok]").popover('destroy');

            $("[id^=tok]").popover({
                placement: "bottom",
                content: function () {
                    var html = $("#buttons").html();
                    var out = " <div id='popover" + $(this)[0].id + "'>" + html + "</div>";
                    return out;
                },
                title: function () {
                    var t = $(this)[0];
                    return "Labeled: " + t.className + ", id: " + t.id;
                },
                html: true,
                trigger: "manual"
            });

            $("[id^=tok]").off("mouseup");

            $("[id^=tok]").mouseup(function(event){
                // only toggle on the left click.
                if(event.which == 1) {
                    $(this).popover("toggle");
                }

            });

            // on right click, change label to nothing.
            $("[id^=tok]").contextmenu(function(event){
                event.preventDefault();
                var spanid = event.currentTarget.id;
                console.log("Right clicked on " + spanid);

                removelabel(spanid);
            });
        }

        loadtok();

        $("#dictbutton").click(function(){
            $.ajax({
                method: "GET",
                url: "/bootstrap/toggledefs",
                data: {groupid: getParameterByName("groupid")}
            }).done(function (msg) {
                console.log("successful toggle");
                $("#htmlcontainer").html(msg);
                loadtok();
            });

        });

        $("[id^=submit-]").click(function(){
            console.log("Clicked on:" + this.id)
            var key = this.id.split("-")[1];
            var val = $("#def-" + key).val();
            console.log("you want to submit: " + key + ", " + val);
            $.ajax({
                method: "GET",
                url: "/dict/add",
                data: {key:key, val:val, taid: getParameterByName("taid")}
            }).done(function (msg) {
                console.log("successful addition");
                $("#text").html(msg);
                loadtok();

                // this is the simplest option... although it is something of a hack.
                $("#div-" + key).html("[" + val + "]");

            });
        });

        $("#loadtokbutton").click(function(){
            loadtok();
        });

        $("#removebutton").click(function(){
            if (confirm('Are you sure you want to remove all?')) {
                $("#savebutton").html("<span class=\"glyphicon glyphicon-floppy-disk\" aria-hidden=\"true\"></span> Save");
                $("#savebutton").css({"border-color" : "#c00"});
                $.ajax({
                    method: "POST",
                    url: "/removeall",
                    data: {id: getParameterByName("taid")}
                }).done(function (msg) {
                    console.log("successful removal.");
                    $("#text").html(msg);
                    loadtok();
                });
            }
        });




        // this runs when you click on a single button.
        $(".container").on("click", "button", function(){
            var buttonvalue = $(this)[0].value;

            console.log($(this).parents());
            var spanid = $(this).parents("[id^=popovertok]")[0].id;

            var sentid = $(this).parents(".panel-body")[0].id;
            console.log(sentid);

            console.log("Clicked on a button..." + buttonvalue);

            var sel = document.getSelection();

            var fid = sel.anchorNode.parentElement.id;
            var lid = sel.focusNode.parentElement.id;

            // check if these ids are actual nodes.
            if(fid.startsWith("tok-") && lid.startsWith("tok-") && lid != fid){
                var startid = fid;
                var endid = "tok-" + (getnum(lid) + 1);

            }else{
                var startid = $(this).parents("[id^=popovertok]")[0].id;
                var endid = "tok-" + (getnum(startid) + 1);
            }

            addlabel(sentid, startid, endid, buttonvalue);
        });


        function getParameterByName(name) {
            var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
            return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
        }

        // given a span id (e.g. tok-4), return the integer
        function getnum(spanid){
            return parseInt(spanid.split("-").slice(-1)[0]);
        }

        // Given a span, remove the label.
        function removelabel(spanid) {

            $("#savebutton").html("<span class=\"glyphicon glyphicon-floppy-disk\" aria-hidden=\"true\"></span> Save");
            $("#savebutton").css({"border-color" : "#c00"});

            console.log("Removing label from: " + spanid);
            var tok = $(document.getElementById(spanid));

            var sentid = tok.parents(".panel-body")[0].id;
            console.log(sentid);

            // returns just the number of the token. tok-4, returns 4.
            var tokid = getnum(spanid);

            $.ajax({
                method: "POST",
                url: "/bootstrap/removetoken",
                data: {sentid: sentid, tokid: tokid}
            }).done(function (msg) {
                console.log("successful removal.");
                $(document.getElementById(sentid)).html(msg);
                loadtok();
            });

        }

        // run this function when you click on a token.
        function addlabel(sentid, starttokid, endtokid, newclass) {
            console.log("Adding " + newclass + " to " + starttokid + "---" + endtokid + ", sentid=" + sentid);

            $("#savebutton").html("<span class=\"glyphicon glyphicon-floppy-disk\" aria-hidden=\"true\"></span> Save");
            $("#savebutton").css({"border-color" : "#c00"});

            $.ajax({
                method: "POST",
                url: "/bootstrap/addspan",
                data: {label: newclass, starttokid: getnum(starttokid), endtokid:getnum(endtokid), sentid: sentid, groupid: getParameterByName("groupid")}
            }).done(function (msg) {
                refreshsents();
            });
        };

        function refreshsents(){
            var groupid= getParameterByName("groupid");
            $.ajax({
                method: "POST",
                url: "/bootstrap/gethtml",
                data: {groupid: groupid}
            }).done(function (msg) {
                $("#htmlcontainer").html(msg);
                loadtok();
            });
        }

        $("[id^=addlabel-]").click(function(d){

            var label = $(this).text();
            var text= getParameterByName("groupid");

            $("#savebutton").html("<span class=\"glyphicon glyphicon-floppy-disk\" aria-hidden=\"true\"></span> Save");
            $("#savebutton").css({"border-color" : "#c00"});

            $.ajax({
                method: "GET",
                url: "/bootstrap/addtext",
                data: {text: text, label: label, groupid: getParameterByName("groupid")}
            }).done(function (msg) {
                console.log(msg);
                refreshsents();
            });
        });

        function save(){
            var groupid = getParameterByName("groupid");
            console.log("saving group: " + groupid);

            $.ajax({
                url: "/bootstrap/save",
                data: {groupid: groupid},
                beforeSend: function() {
                    // setting a timeout
                    $("#savebutton").html("<span class=\"fa fa-spinner fa-spin\"></span> Saving...");
                }
            }).done(function (msg) {
                console.log("finished saving!");
                $("#savebutton").html("<span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span> Saved!");
                $("#savebutton").css({"border-color" : ""});



            });

        };
        $( "#savebutton" ).click(save);
    });


    /*]]>*/
</script>

<template id="buttons">
    <div class="container-fluid">

        <div th:each="label,iterStat : ${labels}" th:if="${iterStat.index % 2 == 0}" class="form-group">
            <div class="row">
                <div class="col-md-4">
                    <button type="button" th:id="${labels[iterStat.index]}" class="btn" th:classappend="${labels[iterStat.index]}" th:field="${labels[iterStat.index]}" th:value="${labels[iterStat.index]}" th:text="${labels[iterStat.index]}"></button>
                </div><x></x>
                <div class="col-md-4" th:if="${iterStat.index+1} &lt; ${labels.size()}">
                    <button type="button" th:id="${labels[iterStat.index+1]}" class="btn" th:classappend="${labels[iterStat.index+1]}" th:field="${labels[iterStat.index+1]}" th:value="${labels[iterStat.index+1]}" th:text="${labels[iterStat.index+1]}"></button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="row">
                <div class="col-md-4">
                    <button type="button" id="O" class="btn btn-default" value="O">No label</button>
                </div>
            </div>
        </div>

    </div>
</template>

</html>