<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Bootstrap Home</title>
    <div th:include="bs-base :: bs-head"></div>

</head>
<body>
<div th:include="bs-base :: bs-nav"></div>
<div class="container">


    <div th:if="${groupid} == null">
        <div th:each="groupid : ${groups.keySet()}" class="list-group-item">
            <h3 th:text="'Group ' + ${groupid} + ' (' + ${groups.get(groupid).size()} + ' sentences)'"></h3>
            <a th:href="'/bootstrap/sents?groupid=' + ${groupid}">Hopefully related to the group...</a>
        </div>
    </div>


    <div th:unless="${groupid} == null">
        <h3 th:text="'Group: ' + ${groupid}"></h3>

        <div class="row">
            <div class="col-md-8">
                <div th:each="sent : ${sents}" class="panel panel-default">
                    <div  th:text="${sent.getTextAnnotation().getId() + ':' + sent.getSentenceId()}" class="panel-heading"></div>
                    <div class="panel-body text" th:id="${sent.getTextAnnotation().getId() + ':' + sent.getSentenceId()}" th:utext="${sent.getAttribute('html')}">
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <button class="btn btn-default" type="button" id="loadtokbutton">Button</button>
            </div>
        </div>
    </div>



</div>
</body>


<script th:inline="javascript">
    /*<![CDATA[*/

    $(document).ready(function() {

        function loadtok(){
            console.log("loadtok called...");


            $(function () {
                $('[data-toggle="tooltip"]').tooltip()
            })


            // just clean everything out first...
            //$("[id^=tok]").popover('destroy');

            $("[id^=tok]").popover({
                placement: "bottom",
                content: function () {
                    var html = $("#buttons").html();
                    var out = " <div id='popover" + $(this)[0].id + "'>" + html + "</div>";
                    return out;
                },
                title: function () {
                    var t = $(this)[0];
                    return "Labeled: " + t.className + ", id: " + t.id;
                },
                html: true,
                trigger: "manual"
            });

            $("[id^=tok]").mouseup(function(event){
                // only toggle on the left click.
                if(event.which == 1) {
                    $(this).popover("toggle");
                }

            });

            // on right click, change label to nothing.
            $("[id^=tok]").contextmenu(function(event){
                event.preventDefault();
                var spanid = event.currentTarget.id;
                console.log("Right clicked on " + spanid);

                removelabel(spanid);
            });
        }

        loadtok();

        $("#dictbutton").click(function(){
            $.ajax({
                method: "GET",
                url: "/toggledefs",
                data: {taid: getParameterByName("taid")}
            }).done(function (msg) {
                console.log("successful toggle");
                $("#text").html(msg);
                loadtok();
            });

        });

        $("[id^=submit-]").click(function(){
            console.log("Clicked on:" + this.id)
            var key = this.id.split("-")[1];
            var val = $("#def-" + key).val();
            console.log("you want to submit: " + key + ", " + val);
            $.ajax({
                method: "GET",
                url: "/dict/add",
                data: {key:key, val:val, taid: getParameterByName("taid")}
            }).done(function (msg) {
                console.log("successful addition");
                $("#text").html(msg);
                loadtok();

                // this is the simplest option... although it is something of a hack.
                $("#div-" + key).html("[" + val + "]");

            });
        });

        $("#loadtokbutton").click(function(){
            loadtok();
        });

        $("#removebutton").click(function(){
            if (confirm('Are you sure you want to remove all?')) {
                $("#savebutton").html("<span class=\"glyphicon glyphicon-floppy-disk\" aria-hidden=\"true\"></span> Save");
                $("#savebutton").css({"border-color" : "#c00"});
                $.ajax({
                    method: "POST",
                    url: "/removeall",
                    data: {id: getParameterByName("taid")}
                }).done(function (msg) {
                    console.log("successful removal.");
                    $("#text").html(msg);
                    loadtok();
                });
            }
        });



        // this runs when you click on a single button.
        $(".container").on("click", "button", function(){
            var buttonvalue = $(this)[0].value;

            console.log($(this).parents());
            var spanid = $(this).parents("[id^=popovertok]")[0].id;

            var sentid = $(this).parents(".panel-body")[0].id;
            console.log(sentid);

            console.log("Clicked on a button..." + buttonvalue);
            console.log("refers to: " + spanid);

            var sel = document.getSelection();

            var fid = sel.anchorNode.parentElement.id;
            var lid = sel.focusNode.parentElement.id;

            // check if these ids are actual nodes.
            if(fid.startsWith("tok-") && lid.startsWith("tok-") && lid != fid){
                console.log(this);
                console.log("Showing popover for span: " + fid + "-" + lid)
                var startid = fid;
                var endid = "tok:" + (getnum(lid) + 1);

            }else{
                var startid = $(this).parents("[id^=popovertok]")[0].id;
                var endid = "tok:" + (getnum(startid) + 1);
            }

            addlabel(sentid, startid, endid, buttonvalue);
        });


        function getParameterByName(name) {
            var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
            return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
        }

        // given a span id (e.g. tok-4), return the integer
        function getnum(spanid){
            return parseInt(spanid.split(":").slice(-1)[0]);
        }

        // check if s is labeled...
        // this expects a string.
        function isLabeled(spanid){
            if(!spanid.startsWith("#")){
                spanid = "#" + spanid;
            }
            var p = $(spanid).parent();
            return p.hasClass("cons");
        }


        // Given a span, remove the label.
        function removelabel(spanid) {

            // not sure if this check is necessary?
            if (isLabeled(spanid)) {
                $("#savebutton").html("<span class=\"glyphicon glyphicon-floppy-disk\" aria-hidden=\"true\"></span> Save");
                $("#savebutton").css({"border-color" : "#c00"});

                console.log("Removing label from: " + spanid);

                // returns just the number of the token. tok-4, returns 4.
                var tokid = getnum(spanid);

                $.ajax({
                    method: "POST",
                    url: "/removetoken",
                    data: {tokid: tokid, id: getParameterByName("taid")}
                }).done(function (msg) {
                    console.log("successful removal.");
                    $("#text").html(msg);
                    loadtok();
                });
            }
        }

        // run this function when you click on a token.
        function addlabel(sentid, starttokid, endtokid, newclass) {
            console.log("Adding " + newclass + " to " + starttokid + "---" + endtokid + ", sentid=" + sentid);

            $.ajax({
                method: "POST",
                url: "/bootstrap/addspan",
                data: {label: newclass, starttokid: getnum(starttokid), endtokid:getnum(endtokid), sentid: sentid, groupid: getParameterByName("groupid")}
            }).then(function (msg) {
                console.log(msg);
                var ret = refreshsents();
                return ret
            }).done(function(f){
                console.log(f);
                loadtok();
            });
        };

        function refreshsents(){
            $(".text").each(function() {
                var sentid = this.id;

                $.ajax({
                    method: "POST",
                    async: false,
                    url: "/bootstrap/gethtml",
                    data: {sentid: sentid}
                }).done(function (msg) {
                    var panel = $(document.getElementById(sentid));
                    panel.html(msg);
                });
            });
            return "Finished with refresh...";
        };

    });


    /*]]>*/
</script>

<template id="buttons">
    <div class="container-fluid">

        <div th:each="label,iterStat : ${labels}" th:if="${iterStat.index % 2 == 0}" class="form-group">
            <div class="row">
                <div class="col-md-4">
                    <button type="button" th:id="${labels[iterStat.index]}" class="btn" th:classappend="${labels[iterStat.index]}" th:field="${labels[iterStat.index]}" th:value="${labels[iterStat.index]}" th:text="${labels[iterStat.index]}"></button>
                </div><x></x>
                <div class="col-md-4" th:if="${iterStat.index+1} &lt; ${labels.size()}">
                    <button type="button" th:id="${labels[iterStat.index+1]}" class="btn" th:classappend="${labels[iterStat.index+1]}" th:field="${labels[iterStat.index+1]}" th:value="${labels[iterStat.index+1]}" th:text="${labels[iterStat.index+1]}"></button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <div class="row">
                <div class="col-md-4">
                    <button type="button" id="O" class="btn btn-default" value="O">No label</button>
                </div>
            </div>
        </div>

    </div>
</template>

</html>